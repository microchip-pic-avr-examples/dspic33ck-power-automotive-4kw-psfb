<!-- HTML header for doxygen 1.8.20-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>4kW dsPIC33C PSFB DC-DC DA: Firmware Overview</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(function() { init_search(); });
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="mchp.css" rel="stylesheet" type="text/css"/>
<link href="mchp_theme.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0" style="border:0px; border-spacing: 0px; border-collapse: collapse; vertical-align: middle; width: 100%;">
    <tbody>
        <tr style="border: none; background-color: #00000000;">
            <!--SITE HEADER-->
            <td style="width: 120px; border: none;">
                <img alt="Bar" height="60px" src="images/mchp-brandingelement-rgb2.png"/>
            </td>
            <td style="width: 220px; border: none;">
                <img alt="Logo" height=50px src="images/microchip.png"/>
            </td>
            <td colspan="4" style="font-size: 16pt; font-weight: bolder;">
                4kW dsPIC33C PSFB DC-DC DA (Part-No. ) 
            </td>
            <td style="text-align: right; vertical-align: middle;">
                        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect" class="search-icon" onmouseover="return searchBox.OnSearchSelectShow()" onmouseout="return searchBox.OnSearchSelectHide()"><span class="search-icon-dropdown"></span></span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><div id="MSearchCloseImg" class="close-icon"></div></a>
          </span>
        </div>
            </td>
            <!--END SITE HEADER-->
        </tr>
        <tr style="height:36px; border:none; background-color: #000000b0;">
            <td style="width: 70px; color: white; font-size:14px; font-weight: bolder; margin-left: 30px;">
                <div style="margin-left: 30px;">Content</div>
            </td>
            <td style="width: 10px; color: white; font-size:14px; font-weight: bolder;">
                &nbsp;
            </td>
            <td style="width: 100px; color: white; font-size:14px; font-weight: bolder;">
                <!-- Overview -->
            </td>
            <td style="width: 130px; color: white; font-size:14px; font-weight: bolder;"> 
                <!-- Documentation -->
            </td>
            <td style="width: 170px; color: white; font-size:14px; font-weight: bolder;"> 
                <!-- Additional Resources -->
            </td>
            <td style="width: auto; color: white; font-size:14px; font-weight: bolder;"> 
              &nbsp;
            </td>
            <td style="width: 310px; margin-right: 30px; color: white; font-size:10px; font-weight: lighter; text-align: right;">
                &nbsp;
            </td>
        </tr>
    </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('a00654.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Firmware Overview </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md13"></a></p>
<p>Microcontroller-based Switch Mode Power Supplies need to be both real-time and deterministic, while also taking advantage of the flexibility offered by programmable microcontrollers. The firmware for these power supplies handles various tasks, some of which must be deterministic, while others, being less critical, do not require deterministic execution. This design approach is evident in the use of interrupts and the repetition of tasks at different frequencies. These aspects will be explored in detail in the Firmware Structure and Implementation section later.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md14"></a>
Firmware components</h1>
<center><a href="images/sensors.png" target="_blank" rel="nofollow"><img src="images/sensors.png" alt="Overview of the sensors and microcontroller peripherals used in power transfer" width="800" class="inline"/> </a> </center> <center>  Overview of the sensors and microcontroller peripherals used in power transfer  </center> <p>The Firmware for PSFB DCDC Converter has the following components </p><h2>Input/Output Rail Sensing</h2>
<p>When designing a power converter, it's important to monitor both the input and output voltages and currents. This is done by scaling the voltages to levels that the microcontroller's ADC sense lines can handle. The primary side current is measured with a current transformer, while the output current is detected using a shunt amplifier. Both of these current measurements are then converted into voltage signals that the analog sense lines can process.</p>
<h4>Peripheral Used : High Speed 12-bit Analog to Digital Converter(ADC)</h4>
<p>The dsPIC33CK256MP506 devices have a high-speed, 12-bit Analog-to-Digital Converter (ADC) that features a low conversion latency, high resolution and oversampling capabilities to improve performance in AC/DC, DC/DC power converters. The devices implement the ADC with three SAR cores, two dedicated and one shared. Two of these cores are faster dedicated cores which are dedicated to specific channels and are used to sample the input and output currents. The other core, which is a shared core supporting a higher number of channels, is used to sample the input and output voltages.</p>
<p>Following table lists all the analog channels of the PSFB converter</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">S.no  </th><th class="markdownTableHeadNone">Net name  </th><th class="markdownTableHeadNone">MCU details  </th><th class="markdownTableHeadNone">Description  </th><th class="markdownTableHeadNone">Sampling Trigger  </th><th class="markdownTableHeadNone">Sampling Rate  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">1  </td><td class="markdownTableBodyNone">FB_P_CT_FILT  </td><td class="markdownTableBodyNone">Dedicated Core 0 Conversion Time: 328ns  </td><td class="markdownTableBodyNone">Primary Current. Sensed through a CT.  </td><td class="markdownTableBodyNone">Sampled at half of the Duty Cycle.  </td><td class="markdownTableBodyNone">Sampled Cycle by Cycle, 100kHz  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">2  </td><td class="markdownTableBodyNone">I_SEC_AVG_FILT  </td><td class="markdownTableBodyNone">Dedicated Core 1 Conversion Time: 328ns  </td><td class="markdownTableBodyNone">Output Current. Sensed through Shunt.  </td><td class="markdownTableBodyNone">Sampled at half of the Duty Cycle.  </td><td class="markdownTableBodyNone">Sampled Cycle by Cycle, 100kHz  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">3  </td><td class="markdownTableBodyNone">FB_VOUT  </td><td class="markdownTableBodyNone">Shared Core Channel 2 Conversion Time: 470ns  </td><td class="markdownTableBodyNone">Output Voltage Shared Core, Channel 2  </td><td class="markdownTableBodyNone">Sampled at half of the Duty Cycle  </td><td class="markdownTableBodyNone">Sampled Cycle by Cycle, 100kHz  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">4  </td><td class="markdownTableBodyNone">VIN_INT_AN  </td><td class="markdownTableBodyNone">Shared Core Channel 10 Conversion Time: 670ns (value available after 670ns after triggering)  </td><td class="markdownTableBodyNone">Input Voltage  </td><td class="markdownTableBodyNone">Software Trigger  </td><td class="markdownTableBodyNone">Sampled Cycle by Cycle, 100kHz  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">5  </td><td class="markdownTableBodyNone">FB_VCAP  </td><td class="markdownTableBodyNone">Shared Core Channel 9 Conversion Time: 470ns (value available after 470ns after triggering)  </td><td class="markdownTableBodyNone">Output Capacitor Voltage  </td><td class="markdownTableBodyNone">Software Trigger  </td><td class="markdownTableBodyNone">Sampled Cycle by Cycle, 100khz  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">5  </td><td class="markdownTableBodyNone">FP_TEMP  </td><td class="markdownTableBodyNone">Shared Core Channel 14 Conversion Time: 900ns (value available after 900ns after triggering)  </td><td class="markdownTableBodyNone">Temperature Sensor  </td><td class="markdownTableBodyNone">Software Trigger  </td><td class="markdownTableBodyNone">Sampled Cycle by Cycle, 100khz  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">6  </td><td class="markdownTableBodyNone">FB_5V  </td><td class="markdownTableBodyNone">Shared Core Channel 19 Conversion Time: 1400ns (value available after 1388ns after triggering)  </td><td class="markdownTableBodyNone">5 Volt Rail  </td><td class="markdownTableBodyNone">Software Trigger  </td><td class="markdownTableBodyNone">Sampled Cycle by Cycle, 100khz  </td></tr>
</table>
<h3>Sensor calibration at startup</h3>
<p>Input and Output Current sensors both have offsets of about 500mV. These are measured before power transfer.</p>
<h2>PWM Signals for Phase Shifted Operation</h2>
<p>In phase shifted design, the power transfer happens by the phase-shift between the fixed and phase shifted legs of the bridge. Due to this phase shift a bipolar voltage appears at the primary of the transformer.</p>
<h4>Peripheral Used: PWM Generator</h4>
<p>The control signal directed to the power stage is determined by the phase shift value between the fixed and phase-shifted legs. The primary side switches are actuated using the High-Resolution Pulse Width Modulation (PWM) with fine edge placement peripheral of the dsPIC33CK microcontroller. This peripheral is exceptionally versatile, facilitating the execution of intricate modulation schemes autonomously within the controller's core-independent peripheral. During phase-shifted operation, the phase-shifted leg is synchronized with the fixed leg. A phase shift is introduced to generate a bipolar voltage at the transformer, utilizing a highly adaptable trigger mechanism. This phase-shift is the control output from the compensator to the power stage. For more details on the workings of the PWM Peripheral, refer to the <a href="https://microchip.com/70005320">PWM Family Reference Manual.</a> The Trigger mechanisms are summarized in the table below.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">PWM Generator Number  </th><th class="markdownTableHeadCenter">Details  </th><th class="markdownTableHeadCenter">Function  </th><th class="markdownTableHeadCenter">Start of Cycle Trigger  </th><th class="markdownTableHeadCenter">Peripheral Setting  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">PWM Generator 1 (PG1)  </td><td class="markdownTableBodyCenter">Complimentary PWM at 100kHz at 50% Duty Cycle, Dead Time 160ns  </td><td class="markdownTableBodyCenter">Generating Signals for the Fixed Leg of PSFB  </td><td class="markdownTableBodyCenter">Self-Running  </td><td class="markdownTableBodyCenter">PG1 End of Cycle  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">PWM Generator 3 (PG3)  </td><td class="markdownTableBodyCenter">Complimentary PWM at 100kHz at 50% Duty Cycle, Dead Time 160ns  </td><td class="markdownTableBodyCenter">Generating Signals for the Phase Shifted Leg of PSFB  </td><td class="markdownTableBodyCenter">Phase Delayed and Synchronized to PG1  </td><td class="markdownTableBodyCenter">Trigger Value from PG1  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">PWM Generator 2 (PG2)  </td><td class="markdownTableBodyCenter">Complimentary PWM at 100kHz, Swapped. Only High Side signal used  </td><td class="markdownTableBodyCenter">Generating the Synchronous rectifier signal for SR2  </td><td class="markdownTableBodyCenter">Synchronized to PG3. Duty Cycle = Period – Phase Delay  </td><td class="markdownTableBodyCenter">Trigger value from PG3 and swapping the high and low side signal.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">PWM Generator 4 (PG4)  </td><td class="markdownTableBodyCenter">Complimentary PWM at 100kHz, Swapped. Only High Side Signal used  </td><td class="markdownTableBodyCenter">Generating the Synchronous rectifier signal for SR1  </td><td class="markdownTableBodyCenter">Synchronized to PG1. Duty Cycle = Period – Phase Delay  </td><td class="markdownTableBodyCenter">Trigger value from PG1 and swapping the high and low side signal.  </td></tr>
</table>
<h3>Seconndary Rectifiers DCM/CCM</h3>
<p>The PWM signals for the Secondary Rectifiers are generated using PWM Generator 2 (PG2) and PWM Generator 4 (PG4). The decision to turn on and off Secondary Rectifiers depends upon the load current. If the load current is high enough for CCM operation, then the Secondary rectifiers are turned on, otherwise the body diodes of the secondary side MOSFETs are used to conduct.</p>
<center><a href="images/SR_inv.png" target="_blank" rel="nofollow"><img src="images/SR_inv.png" alt="2p2z" width="600" class="inline"/> </a> </center> <center>  PSFB PWM waveforms. D0 and D1 are complementary waveforms for fixed leg, D2 and D3 are for phase shifted leg. C1 and C4 are Secondary Rectifier Signals.  </center> <h2>Compensation and Control</h2>
<p>The changes to the input and output voltages and/or currents must not affect the stability of the system or damage the connected load. To ensure the integrity of the operation, the changes to the output and input voltages and currents are compensated for by using established control theory practices.</p>
<h3>Voltage Loop</h3>
<p>A fundamental approach to regulating the output voltage involves the implementation of a voltage loop. This voltage loop continuously monitors the output voltage for any deviations and compensates for these fluctuations by adjusting the controlled parameter applied to the plant (i.e. duty cycle, period, etc.) applied to the plant. However, relying solely on the voltage loop is often insufficient due to its inherently slow response time. Additionally, the voltage loop lacks the capability for cycle-by-cycle current control, which is critical for maintaining precise and stable operation. A cascaded approach is essential that employes both a current loop and a voltage loop.</p>
<h3>Current Loop</h3>
<p>To address the limitations inherent in the voltage loop, the inclusion of a current loop is essential. In the context of this design, two methodologies for current loops were evaluated: Peak Current Mode Control and Average Current Mode Control</p>
<h3>Average current mode control vs Peak Current Mode Control</h3>
<p>In this design, the Average Current Mode is chosen. Average Current Mode Control provides various advantages in the context of Power Converter methodology, such as easier control schemes, working better with droop control methods, and providing more flexibility for maximum efficiency as it gives more control over edge positions. <br  />
 Peak Current Mode Control (PCMC) has its own advantages, such as rapid transient response and reduced computational workload on the CPU. <br  />
 The fundamental difference between PCMC and Average Current Mode Control (ACMC) lies in managing transformer magnetization and current regulations. <br  />
 PCMC aims to prevent staircase saturation by ensuring equal currents, whereas ACMC achieves this by enforcing equal on-times to maintain balanced magnetization in the transformer. PCMC requires a highly symmetric current sense signal. On the contrary, ACMC is more tolerant of imprecise feedback, if the half-bridges respond uniformly. <br  />
 In well-designed systems, the switch timings of each bridge are typically synchronized, making ACMC a straightforward approach due to its leniency towards feedback signal symmetry. This tolerance simplifies the design process, as achieving a perfectly symmetric current feedback signal is not always feasible.</p>
<h3>Digital Compensators</h3>
<p>The 2-pole/2-zero and 3-pole/3-zero are digital implementations of type II analog and type III analog compensators. These are filters designed to introduce specific gain and phase boosts by strategically placing poles and zeros in the frequency domain.</p>
<center><a href="images/3p3z.png" target="_blank" rel="nofollow"><img src="images/3p3z.png" alt="4kw Control" width="600" class="inline"/> </a> </center> <center>  Digital implementation of type 3 Analog controller  </center> <h3>Poles and Zeros</h3>
<p>For Current loop a 3 pole 3 zero compensator is used, and for Voltage Loop a 2 Pole 2 zero compensator is used. These values gave enough margin in the overall system response for gain and phase to ensure a stable operation. For test results please refer to the operational manual.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">3p3z Current Loop  </th><th class="markdownTableHeadNone">Frequency(Hz)  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Pole 0  </td><td class="markdownTableBodyNone">8000 Hz  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Pole 2  </td><td class="markdownTableBodyNone">21000 Hz  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Pole 3  </td><td class="markdownTableBodyNone">40000 Hz  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Zero 1  </td><td class="markdownTableBodyNone">3000 Hz  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Zero 2  </td><td class="markdownTableBodyNone">6000 Hz  </td></tr>
</table>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">2p2z Voltage Loop  </th><th class="markdownTableHeadNone">Frequency(Hz)  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Pole 0  </td><td class="markdownTableBodyNone">60 Hz  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Pole 2  </td><td class="markdownTableBodyNone">45000 Hz  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Zero 1  </td><td class="markdownTableBodyNone">40 Hz  </td></tr>
</table>
<h3>Implemenation using DCDT and SMPS Control Library</h3>
<p>The Analog controllers of two poles two zeros, and three poles three zeros are implemented in the digital domain by transforming the compensator transfer function from the s-domain to the z-domain.</p>
<p>The Digital Compensator Design Tool (DCDT), a complimentary plugin available within the MPLAB X Integrated Development Environment (IDE), is employed to determine the digital compensator coefficients by entering the location of Poles and Zeros in frequence domain. Based on the locations of the poles and zeros, the coefficients for the z-domain equation are computed.</p>
<p>These coefficients are utilized within the Switched-Mode Power Supply (SMPS) control library, which is also provided free of charge by Microchip. The SMPS control library offers efficient and high-speed assembly libraries to facilitate the updating of control loops. For more information on DCDT refer to the <a href="https://www.microchip.com/en-us/development-tool/dcdt">DCDT’s webapage.</a></p>
<center><a href="images/DCDT.png" target="_blank" rel="nofollow"><img src="images/DCDT.png" alt="4kw Control" width="800" class="inline"/> </a> </center> <center>  Digital Compensator Design Tool  </center> <h3>Complete Control Scheme</h3>
<p>The diagram illustrates the comprehensive control scheme for the PSFB DCDC converter. The outer voltage loop acquires its reference through a soft-start mechanism, wherein the reference is incrementally ramped up. This outer voltage loop subsequently provides a reference to the internal current loop. Both control loops operate on a cycle-by-cycle basis.</p>
<center><a href="images/4kW_control.png" target="_blank" rel="nofollow"><img src="images/4kW_control.png" alt="4kw Control" width="800" class="inline"/> </a> </center> <center>  4kw Control  </center> <h2>Fault Handling</h2>
<p>There are two levels of Fault monitoring and handling. </p><h3>Hardware based fault monitoring</h3>
<p>The primary over current Fault handling is done by monitoring the input current using a comparator.</p>
<h4>Peripheral Used: High Speed Analog comparator with slope compensation DAC</h4>
<p>dsPIC33CK has high speed analog comparator with slope compensation DAC. The Primary Overcurrent condition will trigger a fault, which will stop switching on the primary side. The secondary rectifiers will be turned off as soon as the current falls below a certain threshold.</p>
<h3>Software based fault monitoring</h3>
<p>The Primary Over/Under Voltage, Secondary Over/Under voltage, Secondary Overcurrent, and Over Temperature are sensed through ADC and monitored for fault conditions every PWM cycle of the fixed leg. The fault response is the same as the hardware fault response, i.e. turn off the PWM signals for fixed and phase shifted legs. Secondary side switches are turned off when the current falls below CCM/DCM threshold.</p>
<h2>Communication and Visualization</h2>
<p>The PSFB has an isolated CAN-FD interface. The design is intended to work with Power Board Visualizer. With Power Board Visualizer the important parameters and the current state of the PSFB can be observed in real time. The output voltage reference can also be changed using a voltage slider.</p>
<h3>Peripheral Used: Controller Area Network (CAN FD) Module</h3>
<p>dsPIC33CK comes with a highly versatile CAN FD module. The transmission and receiving of messages are taken care of by the peripheral.</p>
<p>The complete information about the CAN-FD messages can be seen by clicking the info tab of the PBV Project.</p>
<h2>House Keeping</h2>
<p>The system monitors additionally the five-volt line, as well as the system temperature. Overtemperature, or a dip in five-volt line will also generate a fault condition.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md15"></a>
Implementation</h1>
<h2>Firmware Architecture</h2>
<p>The firmware architecture uses a simple yet effective task scheduler. This simple task scheduler enables different tasks to run at different frequencies. The system tick is generated by using the Timer 1 of the dsPIC33CK.</p>
<center><a href="images/arch.png" target="_blank" rel="nofollow"><img src="images/arch.png" alt="4kw Control" width="800" class="inline"/> </a> </center> <center>  Firmware Architecture  </center> <h3>Power Supply State Maching</h3>
<p>The state machine of the Power supply is updated every 100us using the 100us task update of the scheduler.</p>
<center><a href="images/states.png" target="_blank" rel="nofollow"><img src="images/states.png" alt="Power Supply State Machine" width="800" class="inline"/> </a> </center> <center>  Power Supply State Machine  </center> <h4>PCS_INIT</h4>
<p>Initial State of the power converter. In this state the sensor offsets are measured, and the system transtions for PCS_PRECHARGE State</p>
<h4>PCS_PRECHARGE</h4>
<p>Next State of the power converter. here the converter waits for the Start Precharge command from PBV. After the Precharge, it stays in this state, and waits for the Start Power Transfer command from the PBV.</p>
<h4>PCS_STANDBY</h4>
<p>In this state all the controllers are Initialized. And then the control of the switches is handed over to Control loops, and the SR control is handed over to DCM/CCM monitor</p>
<h4>PCS_SOFTSTART</h4>
<p>In this state, the Voltage reference to the loop is ramped up and down.</p>
<h4>PCS_UP_AND_RUNNING</h4>
<p>In this state, the controller maintains the output voltage to the setpoint from Power Board Visualizer. In case the user changes the voltage reference from PBV using the voltage reference slider, the refernce is incremently/decremently applied to the voltage loop in the PCS_SOFTSTART state.</p>
<h4>PCS_FAULT</h4>
<p>In any fault condition, the primary side switches are turned off. The output current is allowed to dissipate, and then the Secondary Rectifiers are turned off. The system is taken out of Fault condition by clicking the Fault Reset button on PBV. Note that if the conditions for fault exist, then the system will immediately jump back into fault state.</p>
<h3>Interupt Based Control Update</h3>
<p>In parallel to Statemachine, an interrupt is generated synchronized with the fixed leg PWM signal. Here all the analog values are updated. These are triggerd as described above. Based on these values faults are monitored, and control loop's feedbacks are updated, and new control loops output values are used to update the PWM Duty Cycles.</p>
<p>The secondary side current read here is also responisble to determine the CCM/DCM conditions. The Secondary Rectifiers are switched on and off based on the output current.</p>
<center><a href="images/int.png" target="_blank" rel="nofollow"><img src="images/int.png" alt="Interrupt Process" width="200" class="inline"/> </a> </center> <center>  Functions in Interrupt  </center> <h3>Control Loop timing/interrupt timing</h3>
<center><a href="images/latency.png" target="_blank" rel="nofollow"><img src="images/latency.png" alt="Interrupt latency" width="800" class="inline"/> </a> </center> <center>  Interrupt Latency  </center> <h2>Peripheral Initalization and Device Drivers</h2>
<h3>Microchip Code Configurator</h3>
<p>Microchip Code Configurator (MCC) is a user-friendly software tool designed to simplify the development process for embedded applications. It offers a graphical interface that allows developers to easily configure and generate initialization and application code for Microchip's 8-bit, 16-bit, and 32-bit microcontrollers. By automating the setup of peripherals and libraries, MCC enables developers to concentrate on creating their application logic, reducing development time and effort. MCC is used to configure all the peripherals of the dsPIC33CK for this project.</p>
<p>MCC comes bundled together with MPLAB X Ide. To visualize the periphreal settings for this projects please click on MCC icon from the toolbar of MPLAB X Ide, once the project has been opened.</p>
<hr  />
<p>&copy; 2025, Microchip Technology Inc.</p>
<hr  />
 </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- HTML footer for doxygen 1.8.20-->
<!-- start footer part -->
<div id="nav-path" class="navpath" style="padding-bottom: 12px; vertical-align: bottom;"><!-- id is needed for treeview function! -->
  <ul>
    <p class="footer" style="text-align: center; font-size: 90%;">
      © Copyright 1998-2022 Microchip Technology Inc. All rights reserved.
    </p>
    </ul>
</div>
</body>
</html>
