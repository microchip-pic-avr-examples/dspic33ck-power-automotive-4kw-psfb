<!-- HTML header for doxygen 1.8.20-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>4kW dsPIC33C PSFB DC-DC DA: Parallel/Droop Operation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(function() { init_search(); });
</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="mchp.css" rel="stylesheet" type="text/css"/>
<link href="mchp_theme.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0" style="border:0px; border-spacing: 0px; border-collapse: collapse; vertical-align: middle; width: 100%;">
    <tbody>
        <tr style="border: none; background-color: #00000000;">
            <!--SITE HEADER-->
            <td style="width: 120px; border: none;">
                <img alt="Bar" height="60px" src="images/mchp-brandingelement-rgb2.png"/>
            </td>
            <td style="width: 220px; border: none;">
                <img alt="Logo" height=50px src="images/microchip.png"/>
            </td>
            <td colspan="4" style="font-size: 16pt; font-weight: bolder;">
                4kW dsPIC33C PSFB DC-DC DA (Part-No. ) 
            </td>
            <td style="text-align: right; vertical-align: middle;">
                        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <span id="MSearchSelect" class="search-icon" onmouseover="return searchBox.OnSearchSelectShow()" onmouseout="return searchBox.OnSearchSelectHide()"><span class="search-icon-dropdown"></span></span>
          <input type="text" id="MSearchField" value="" placeholder="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><div id="MSearchCloseImg" class="close-icon"></div></a>
          </span>
        </div>
            </td>
            <!--END SITE HEADER-->
        </tr>
        <tr style="height:36px; border:none; background-color: #000000b0;">
            <td style="width: 70px; color: white; font-size:14px; font-weight: bolder; margin-left: 30px;">
                <div style="margin-left: 30px;">Content</div>
            </td>
            <td style="width: 10px; color: white; font-size:14px; font-weight: bolder;">
                &nbsp;
            </td>
            <td style="width: 100px; color: white; font-size:14px; font-weight: bolder;">
                <!-- Overview -->
            </td>
            <td style="width: 130px; color: white; font-size:14px; font-weight: bolder;"> 
                <!-- Documentation -->
            </td>
            <td style="width: 170px; color: white; font-size:14px; font-weight: bolder;"> 
                <!-- Additional Resources -->
            </td>
            <td style="width: auto; color: white; font-size:14px; font-weight: bolder;"> 
              &nbsp;
            </td>
            <td style="width: 310px; margin-right: 30px; color: white; font-size:10px; font-weight: lighter; text-align: right;">
                &nbsp;
            </td>
        </tr>
    </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('a00655.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Parallel/Droop Operation </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md18"></a></p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md19"></a>
Theory</h1>
<p>Droop control is a widely used technique in power electronics and power systems for enabling multiple power sources—such as power supplies, converters, or generators—to share load current proportionally when operating in parallel. The primary objective of droop control is to ensure stable and balanced load sharing without the need for direct communication or synchronization between the sources.</p>
<p><b>Principle of Operation</b></p>
<p>In an ideal parallel system, all power sources would maintain exactly the same output voltage, ensuring equal current sharing. However, due to inevitable differences in component tolerances, wiring, and layout, small variations in output voltage can occur. These differences can lead to circulating currents, where one source supplies more current than others, potentially causing overheating or inefficiency.</p>
<p>Droop control addresses this issue by intentionally allowing the output voltage of each power source to decrease (or "droop") as the output current increases. This is typically achieved by introducing a small, controlled resistance—either physically or through control algorithms—into the output path. The result is a linear relationship between output current and output voltage:</p>
<p>$$ V_{out} = V_{ref} - (I_{out} \times R_{droop}) <br  />
 $$</p>
<p>Where:</p>
<p>V<sub>out</sub> is the output voltage, <br  />
 V<sub>ref</sub> is the reference voltage, <br  />
 I<sub>out</sub> is the output current, <br  />
 R<sub>droop</sub> is the droop resistance.</p>
<p><b>Load Sharing Mechanism</b></p>
<p>As the load increases, each power source’s output voltage drops slightly according to its droop characteristic. If one source begins to supply more current than the others, its output voltage will decrease further due to the droop effect. This lower voltage causes the other sources, whose output voltages are now relatively higher, to supply more current, thereby redistributing the load. This self-regulating mechanism ensures that all sources contribute to the load in proportion to their droop settings and rated capacities. Properly designed droop characteristics help prevent any single source from becoming overloaded and promote stable, balanced operation without the need for direct communication or centralized control.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md20"></a>
Implementation</h1>
<h2>Droop Coefficient Calculation</h2>
<ol type="1">
<li><p class="startli"><b>Output Current Range:</b> <br  />
</p>
<p class="startli">$$ \text{Maximum output current} = \frac{2700W}{15V} = 180A $$</p>
<p class="startli">Output Current Range is 180 amps.</p>
</li>
<li><p class="startli"><b>Droop Coefficient Rd:</b> <br  />
 Desired Droop Voltage is 1 Volt over entire voltage range. This was selected $$ R_d = \frac{1V}{180A} $$</p>
<p class="startli">$$ R_d\,\text{counts} = \frac{1V \times 154\,\text{mV}/V \times 4095 / 3.3}{180A \times 10\,\text{mV}/A \times 4095 / 3.3} $$</p>
<p class="startli">where 154mV/V is the gain of the output voltage feedback, and 10mV/A is the gain of the output current sensor.</p>
<p class="startli">$$ R_d\,\text{counts} = \frac{1V \times 154\,\text{mV}/V}{180 \times 10\,\text{mV}/A} = 0.0855\,\text{counts} $$</p>
</li>
<li><p class="startli"><b>Validation:</b></p>
<p class="startli">For a current of 180 amps ADC reads $$ {180A \times 10\,\text{mV}/A \times 4095 / 3.3 = 2233.63} $$</p>
<p class="startli">multiplying this with R<sub>out</sub></p>
<p class="startli">$$ {2233.63 \times 0.0855 = 190.97 \approx 191} $$</p>
<p class="startli">191 is the range of change of Output Voltage reference in raw ADC units. This results in voltage reference change of</p>
<p class="startli">$$ \frac{191 \times 3.3}{4095} \times \frac{1}{154\,\text{mV}/V} = 0.999 V $$</p>
</li>
</ol>
<h2>Calibration and scaling factor</h2>
<p>The Standalone implementation of the PSFB uses the output voltage reference value from PBV. To ensure the correct operation, every board recieves the same voltage reference setpoint, at the same time. The reference value is the <em>calculated</em> adc count value. Due to inevitable differences in component tolerances, wiring, and layout, each board will have its own <em>measured</em> adc value, which will be different from the calculated one. To overcome this, external calibration of the output voltage rail is required. This is done by connecting an external 12 volt supply to the output voltage rail before turning on the boards.</p>
<h2>Droop Implementation</h2>
<p>The state machine implementation is similar to the single board operation.</p>
<p>During the Up and Running State, a new Vref is calcualted every 100ms as per</p>
<p>$$ V_{ref'} = V_{ref PBV} - (I_{out} \times R_{droop}) <br  />
 $$</p>
<p>I<sub>out</sub> is the average output current for that power module. The new V<sub>ref</sub> setpoint causes the State machine to jump back into the Soft Start state, where it slowly ramps down the V<sub>ref</sub>.</p>
<h1 class="doxsection"><a class="anchor" id="autotoc_md21"></a>
How to operate in Droop Mode</h1>
<h2>Preparing DP-PIMs</h2>
<p>To demonstrate droop mode, two PSFB modules are required. Since there is no communication between the two PSFB modules, the same code base is used for both. However, to effectively read the debug data on PBV from each board, the CAN ID of outgoing messages must be changed.</p>
<p>An example XML file is provided with the firmware package, where one set of signals is decoded on CAN ID 0x204, and the other set is decoded on CAN ID 0x214. Both boards receive control inputs on the same CAN ID, ensuring that both operate in sync.</p>
<p>To set up the demonstration, program one DP-PIM with the psfb_droop.X project as provided. For the second DP-PIM, modify the CAN ID in the source file <a class="el" href="a00233_source.html">sources/app/app_PBV_psfb_frame_map.c</a> by changing the PBV_SYSTEM_TO_GUI_ID define to 0x214. Rebuild the project and program the second DP-PIM with this modified firmware.</p>
<h2>Calibration</h2>
<p>Before startup, that is, before input voltage is applied—the output voltage sense must be calibrated. Calibration is performed as follows. Note: At this point, it is helpful to have the PBV project open and CAN communication enabled to view the debug data from both boards.</p>
<ol type="1">
<li>Connect the output voltage rails of both modules in parallel.</li>
<li>Connect a 12-volt supply to the output voltage rail.</li>
<li>Insert the voltage adapter into the barrel jack for the auxiliary supply. Press the reset button to reset the controller. As soon as the controller receives power, it calibrates the output resistor stage and stores the coefficient.</li>
<li>Remove the external 12 V supply.</li>
</ol>
<h2>PBV Control</h2>
<p>After calibration, follow these steps to start the board:</p>
<ol type="1">
<li>Open the PBV project file: 4KW dsPIC33C PSFB DC-DC DA.xml.</li>
<li>Select the correct communication port and enable it.</li>
<li>Verify that everything is set up correctly by checking the status/housekeeping data and ensuring the system is in the PCS_PRECHARGE state.</li>
<li>Click on "Start Precharge." The system will charge the output capacitors in open loop. Note that, at this point, the output stages are in open loop, so there may be disproportionate load sharing.</li>
<li>Click on "Start Power Transfer." The system will quickly transition through various states and should eventually reach the PCS_UP_AND_RUNNING state. At this stage, both systems will share the load.</li>
<li>Change the reference to the desired output voltage value if necessary.</li>
</ol>
<center><a href="images/droop_pbv_204.png" target="_blank" rel="nofollow"><img src="images/droop_pbv_204.png" alt="PSFB project running on Power Board Visualizer GUI" width="800" class="inline"/> </a> </center> <center>  Power Board Visualizer GUI - CAN ID 0x204  </center> <center><a href="images/droop_pbv_214.png" target="_blank" rel="nofollow"><img src="images/droop_pbv_214.png" alt="PSFB project running on Power Board Visualizer GUI" width="800" class="inline"/> </a> </center> <center>  Power Board Visualizer GUI - CAN ID 0x214  </center> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- HTML footer for doxygen 1.8.20-->
<!-- start footer part -->
<div id="nav-path" class="navpath" style="padding-bottom: 12px; vertical-align: bottom;"><!-- id is needed for treeview function! -->
  <ul>
    <p class="footer" style="text-align: center; font-size: 90%;">
      © Copyright 1998-2022 Microchip Technology Inc. All rights reserved.
    </p>
    </ul>
</div>
</body>
</html>
